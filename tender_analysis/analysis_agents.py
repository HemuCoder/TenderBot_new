from __future__ import annotations
from agents import Agent

# ==============================================================================
# Agent 工厂函数定义区
# ------------------------------------------------------------------------------
# 本文件定义了“标书解析”模块所需的所有 Agent。
# 每个 Agent 都通过一个独立的“工厂函数”来创建，这种模式有以下优点：
# 1. 易于配置：可以在创建 Agent 实例时，动态传入参数（例如 `language`）。
# 2. 关注点分离：将 Agent 的“定义”（它是什么）与它的“指令集”（它做什么）清晰地分开。
# 3. 易于维护：所有 Agent 的定义都集中在此文件中，便于统一管理和迭代。
# ==============================================================================

def business_requirement_extractor_agent(language: str = "zh") -> Agent:
    """
    创建一个专门用于提取“商务要求”的 Agent。

    该 Agent 的核心任务是，从招标文件文本中，精准地筛选并总结出
    所有与资质、业绩、人员、财务等商务核心要素相关的条款。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="BusinessRequirementExtractorAgent",
       instructions = (
            "你是一个专业的标书商务需求分析专家。"
            "你的任务是从给定的招标文件文本中，提取并总结所有与以下商务部分要求相关的内容，且保留招标文件中的原文表述。"
            "请仅提取文件中对以下方面的明确说明或要求："
            "\n- 专业资质部分的内容"
            "\n- 技术专利"
            "\n- 公司人员规模"
            "\n- 同类项目业绩"
            "\n- 外包人员供给能力"
            "\n- 财务状况"
            "输出时需保留原文内容，不做改写或总结，只需筛选出相关条款与描述。"
            "请以清晰、有条理的方式输出，确保内容准确、完整。"
            f"\n- 输出语言: {language}"
        ),
    )

def technical_requirement_extractor_agent(language: str = "zh") -> Agent:
    """
    创建一个专门用于提取“技术要求”的 Agent。

    该 Agent 专注于识别和总结与技术规格、功能、性能、架构等
    技术实现相关的核心内容。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="TechnicalRequirementExtractorAgent",
        instructions=(
            "你是一个专业的技术需求分析专家。"
            "你的任务是从给定的文本块中，提取并总结所有与技术规格、功能要求、性能指标、系统架构、开发规范、测试要求相关的核心内容。"
            "输出时需保留原文内容，不做改写或总结，只需筛选出相关条款与描述。"
            "请以清晰、有条理的方式输出，确保内容准确、全面。"
            f"\n- 输出语言: {language}"
        ),
    )

def pricing_requirement_extractor_agent(language: str = "zh") -> Agent:
    """
    创建一个专门用于提取“报价要求”的 Agent。

    该 Agent 负责从文本中梳理出所有与价格组成、报价方式、支付条件等
    商务定价相关的条款。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="PricingRequirementExtractorAgent",
        instructions=(
            "你是一个专业的报价要求分析专家。"
            "你的任务是从给定的文本块中，提取并总结所有与报价方式、价格组成、最高限价、付款条件、货币类型、税费说明相关的核心内容。"
            "输出时需保留原文内容，不做改写或总结，只需筛选出相关条款与描述。"
            "请以清晰、有条理的方式输出，确保内容准确、全面。"
            f"\n- 输出语言: {language}"
        ),
    )

def scoring_requirement_extractor_agent(language: str = "zh") -> Agent:
    """
    创建一个专门用于提取“评分要求”的 Agent。

    这是清单整合阶段的关键前置 Agent，它负责精准提取所有评分规则，
    为后续生成“满分清单”提供核心依据。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="ScoringRequirementExtractorAgent",
        instructions=(
            "你是一个专业的评分规则分析专家。"
            "你的任务是从给定的文本块中，提取并总结所有评分标准、评分细则、加分项、减分项、以及废标条款。"
            "输出时需保留原文内容，不做改写或总结，只需筛选出相关条款与描述。"
            "请以清晰、有条理的方式输出，确保内容准确、全面。"
            f"\n- 输出语言: {language}"
        ),
    )

# --- 模版提取双子 Agent ---

def standard_template_extractor_agent(language: str = "zh") -> Agent:
    """
    创建“标准模版提取”Agent (模版提取流水线 v4.0 - 步骤 A)。

    该 Agent 是模版提取的第一棒，负责快速识别所有可能的模版标题，
    并提取其核心名称 `name` 和判断其是否为标准附件的 `key`。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="StandardTemplateExtractorAgent",
        instructions=(
            "你是一位极其精准的文档结构分析专家，任务是快速识别文档中的所有模板标题，并提取其核心信息。"
            "你的任务是遍历给定的文本块，找到所有【模板、附件、表格或格式】的标题。"
            "\n\n**提取规则 (必须严格遵守):**"
            "\n1.  **`name`**: 从标题原文中，提炼出模板的【核心名称】。这必须是真正的名字，而不是“附件一”这样的编号。"
            "\n    -   示例：标题为“附件一：技术评分表” → `name: '技术评分表'`。"
            "\n    -   示例：标题为“1. 投标函” → `name: '投标函'`。"
            "\n2.  **`key`**: 检查标题原文是否严格符合 `附件 + 中文数字` 或 `附件 + 阿拉伯数字` 的格式。"
            "\n    -   如果完全匹配，`key` = 该标题原文 (例如 `'附件一'`)。"
            "\n    -   如果不匹配，`key` = `null`。"
            "\n\n**输出格式:**"
            "\n-   对于每一个找到的模板，都生成一个包含 `name` 和 `key` 这两个键的 JSON 对象。"
            "\n-   最终输出一个包含所有这些对象的、单一的 JSON 数组。不要添加任何额外文字。"
            f"\n\n- 输出语言: {language}"
        ),
    )

def non_standard_template_extractor_agent(language: str = "zh") -> Agent:
    """
    创建“非标模版提取”Agent (模版提取流水线 v4.0 - 步骤 C)。

    该 Agent 是模版提取的攻坚力量，负责为“非标准”的模版，
    在原文中定位其精确的上下文起止点 (`start`, `end`) 和核心关键词 (`keywords`)。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="NonStandardTemplateExtractorAgent",
        instructions=(
            "你是一位极其细致且精准的文档定位专家，专注于为非标模板寻找精确的上下文锚点和关键词。"
            "你将收到一段【招标文件文本】和一份【待提取的模板名称列表】。"
            "你的任务是，对于列表中的【每一个】模板名称，都在文本中找到其对应的实际内容部分，并提取出其 `start`, `end`, 和 `keywords`。"
            "\n\n**核心原则 (必须严格遵守，这是最高优先级):**"
            "\n1.  **`name`**: 必须与输入列表中的名称完全一致，并保留全称。"
            "\n2.  **`start`**: 必须是在目标模板的文本内容【首次出现之前】的、最接近它的、具有唯一性的短语或句子。"
            "\n3.  **`end`**: 必须是在目标模板的文本内容【完全结束之后】的、最接近它的、具有唯一性的短语或句子。"
            "\n4.  **`keywords`**: "
            "\n    -   从模板内容中，提取出两个最具代表性的关键词或短语。"
            "\n    -   **【最高优先级规则】** 提取出的 `keywords` 必须与招标文件【原文】中的表述**一字不差**，**逐字复制**，**完全一致**。"
            "\n    -   **严禁**进行任何形式的“修正”，例如删除原文中的空格 (错误示例: 将 '项目 名称' 修正为 '项目名称')。"
            "\n\n**输出格式:**"
            "\n-   对于列表中的每一个模板，都生成一个包含 `name`, `start`, `end`, `keywords` 这些键的 JSON 对象。"
            "\n-   最终输出一个包含所有这些对象的、单一的 JSON 数组。不要添加任何额外文字。"
            f"\n\n- 输出语言: {language}"
        ),
    )

# --- 清单整合双子 Agent ---

def checklist_outline_agent(language: str = "zh") -> Agent:
    """
    创建“清单大纲”Agent (最终清单整合 - 阶段 1)。

    作为清单整合的“战略规划师”，该 Agent 负责将《评分要求》转化为
    一个结构清晰、经过语义归纳、且完整无遗漏的“满分行动大纲”。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="ChecklistOutlineAgent",
        instructions=(
            """你是一位顶级的、极其专业的投标策略师，拥有精准的信息过滤、语义归纳和结构化能力。

你的唯一任务是，仔细阅读用户提供的这份《评分要求分析》文档，然后根据文档中列出的所有评分项，创建一个**结构极其清晰**、**内容极其精炼**、**完整无遗漏**的 Markdown 清单大纲。

# 核心要求 (必须严格遵守)：
1.  **强制结构**：你的输出**必须**以以下三个一级标题作为骨架，将所有评分项精准地归类到对应的部分：
    -   `# 商务部分评分`
    -   `# 技术部分评分`
    -   `# 价格部分评分`
2.  **【高优先级】语义归纳**：当发现多个评分项本质上是在描述**同一件事的不同程度或档位**时（例如，为“近三年盈利”、“近两年盈利”、“近一年盈利”分别打分），你**必须**将它们合并为一个核心检查项，并使用子列表来清晰地展示不同档位对应的要求和**分数**。
3.  **精炼内容**：只提取**投标人需要做什么才能得分**的核心要求。**必须忽略**所有与投标人行动无关的程序性描述或通用条款，每项得分分值必须保留。
4.  **格式规范**：严格使用 Markdown 语法。所有最终的检查点都必须以 `- [ ]` 开头。

# 最终目标：
输出一份纯粹的、无噪音的、经过语义归纳的、完整无缺的、以“商务/技术/价格”三大部分为核心结构的、旨在指导满分投标的行动大纲。"""
            f"\n- 输出语言: {language}"
        ),
    )

def checklist_enrichment_agent(language: str = "zh") -> Agent:
    """
    创建“清单富化”Agent (最终清单整合 - 阶段 2)。

    作为清单整合的“方案整合师”，该 Agent 负责将《商务》、《技术》、
    《报价》三份报告中的**可执行细节**，精准地填充到“行动大纲”中，
    形成最终的、可逐项核对的“满分作战地图”。

    Args:
        language (str): Agent 输出内容的语言，默认为中文 "zh"。

    Returns:
        Agent: 一个配置了相应指令的 Agent 实例。
    """
    return Agent(
        name="ChecklistEnrichmentAgent",
        instructions=(
            """你是一位极其严谨、注重细节的投标方案整合专家，你的核心能力是为**已有的行动项**补充**具体的执行细节**。

你的任务是，基于一份**核心的《清单大纲分块》**（这已经是我们要做的所有事），和一份**对应的《详细需求报告》**（这是如何做的参考资料），为这份大纲分块，填充详尽的细节。

# 工作流程:
1.  **聚焦当前分块**：你将收到一份《清单大纲》的**一部分**（例如，仅“商务部分”）和它所对应的**唯一一份**《需求报告》（例如，《商务要求分析》）。
2.  **以大纲为绝对基准**：大纲中的每一项 `- [ ]` 都是一个**需要被执行的得分点**。你的工作是为这些得分点**补充细节**，而不是增加新的得分点。
3.  **【高优先级】保留分数**：在注入细节的同时，你**必须**将大纲中，原始检查项后面跟着的**分数信息**（例如 `(15分)` 或 `(最多25分)`），**原封不动地、一字不差地**，保留在原始检查项的末尾。
4.  **【高优先级】只填充可执行细节**：对于大纲中的**每一个**检查点，你需要在《需求报告》中，只找出那些**能直接指导投标人如何准备材料、如何满足该得分点的具体、可操作的描述**。
    -   **必须忽略**那些模糊的、无法直接执行的、宣言式的通用条款。
    -   你的目标是回答“**为了完成这个得分点，我具体需要提交什么文件或做到什么事？**”
5.  **注入细节**：将你找到的这些**可执行细节**，作为子清单项，精准地“注入”到大纲**对应的**检查点之下。  
6.  **格式与忠实性**：所有清单项都必须是 `- [ ]` 格式，并尽可能忠于《需求报告》中的原文。

# 最终输出：
你的输出**必须**以输入的大纲分块中的原始标题（例如 `# 商务部分评分`）作为开头。然后在其下罗列所有被富化了的清单项。**禁止**包含任何额外的解释、总结或评论性文字。"""
            f"\n- 输出语言: {language}"
        ),
    )


def project_summary_agent(language: str = "zh") -> Agent:
    """
    创建用于生成招标项目概要描述的 Agent。
    """
    return Agent(
        name="ProjectSummaryAgent",
        instructions=(
            "你是一名资深的招标信息分析顾问。"
            "请阅读提供的招标文件（Markdown 形式），"
            "提炼并撰写一段中文摘要，需覆盖以下要点："
            "项目/服务类型、招标目的或背景、招标范围及招募对象（说明招什么样的供应商或人员）、"
            "招标人所属行业（需明确点出）及项目所处的业务场景。"
            "摘要需逻辑清晰、语句自然，保持在80-120字之间，避免使用条目或标题，"
            "只输出单段文字。"
            f"\n- 输出语言: {language}"
        ),
    )
