<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç›®å½•ç”Ÿæˆæ¨¡å— - è°ƒè¯•é¡µé¢</title>
  <style>
    :root {
      --bg: #f7f9fc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --brand: #2563eb;
      --ok: #22c55e;
      --err: #ef4444;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .wrap {
      max-width: 1600px;
      margin: 32px auto;
      padding: 0 16px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: flex-start;
      margin-top: 12px;
    }

    .card {
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--muted);
    }

    input,
    select {
      width: 100%;
      box-sizing: border-box;
      color: var(--text);
      background: #f1f5f9;
      border: 1px solid rgba(15, 23, 42, 0.15);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }

    button {
      appearance: none;
      border: 1px solid rgba(37, 99, 235, 0.2);
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.95), rgba(37, 99, 235, 0.80));
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 13px;
    }

    .label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .title {
      font-weight: 600;
      margin-bottom: 8px;
    }

    #stream-output {
      min-height: 400px;
    }

    #output-log,
    #final-output {
      min-height: 200px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>ç›®å½•ç”Ÿæˆæ¨¡å— - è°ƒè¯•é¡µé¢</h1>
    <div class="main-grid">
      <!-- å·¦æ : æµå¼è¾“å‡º -->
      <div class="card">
        <div class="title">Agent åŸå§‹è¾“å‡º (æµå¼)</div>
        <pre id="stream-output" class="muted" style="background:#f1f5f9; padding:12px; border-radius:10px;"></pre>
      </div>

      <!-- å³æ : æ§åˆ¶ä¸æ—¥å¿— -->
      <div class="card" style="display: flex; flex-direction: column; gap: 16px;">
        <div>
          <div class="title">é€šç”¨é…ç½®</div>
          <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap; margin-top:10px;">
            <div style="min-width:260px;">
              <div class="label">æ¨¡å‹ï¼ˆé»˜è®¤ gpt-4.1-miniï¼‰</div>
              <input id="model" list="model-list" placeholder="gpt-4.1-mini" style="width:260px;"
                value="gpt-4.1-mini" />
              <datalist id="model-list">
                <option value="gpt-4.1-mini"></option>
                <option value="gpt-4o-mini"></option>
              </datalist>
            </div>
            <div style="min-width:200px;">
              <div class="label">è¯­è¨€</div>
              <select id="language" style="padding:10px 12px;">
                <option value="zh" selected>ç®€ä½“ä¸­æ–‡</option>
                <option value="en">English</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <div class="title">ä»»åŠ¡æ§åˆ¶</div>
          <div class="row" style="gap:12px;">
            <button id="btn-full-catalog">ğŸš€ ç”Ÿæˆå®Œæ•´ç›®å½•</button>
            <hr>
            <button id="btn-framework">1. ç”Ÿæˆæ¡†æ¶</button>
            <button id="btn-business">2. ç”Ÿæˆå•†åŠ¡ç›®å½•</button>
            <button id="btn-pricing">3. ç”ŸæˆæŠ¥ä»·ç›®å½•</button>
            <button id="btn-technical">4. ç”ŸæˆæŠ€æœ¯ç›®å½•</button>
          </div>
        </div>

        <div>
          <div class="label">è¿è¡Œæ—¥å¿— (é«˜å±‚äº‹ä»¶)</div>
          <pre id="output-log" class="muted" style="background:#f1f5f9; padding:12px; border-radius:10px;"></pre>
        </div>
        <div>
          <div class="label">æœ€ç»ˆç»“æœé¢„è§ˆ</div>
          <div id="final-output"
            style="border:1px solid rgba(15,23,42,0.15); border-radius:10px; padding:12px; overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modelEl = document.getElementById('model');
    const languageEl = document.getElementById('language');
    const btnFramework = document.getElementById('btn-framework');
    const btnBusiness = document.getElementById('btn-business');
    const btnLinker = document.getElementById('btn-linker');
    const btnTechnical = document.getElementById('btn-technical');
    const btnPricing = document.getElementById('btn-pricing');
    const btnFullCatalog = document.getElementById('btn-full-catalog');
    const outputLog = document.getElementById('output-log');
    const finalOutput = document.getElementById('final-output');
    const streamOutput = document.getElementById('stream-output');

    const allButtons = [btnFramework, btnBusiness, btnTechnical, btnPricing, btnFullCatalog];

    function parseEventData(data) {
      try { return JSON.parse(data); } catch { return data; }
    }

    async function runStream(task) {
      outputLog.textContent = `===== [${task}] æ–°ä¸€è½®å¼€å§‹ =====\n`;
      finalOutput.innerHTML = '';
      allButtons.forEach(btn => btn.disabled = true);
      streamOutput.textContent = '';

      const payload = {
        model: modelEl.value || 'gpt-4.1-mini',
        language: languageEl.value || 'zh',
      };

      try {
        const res = await fetch(`http://localhost:8001/api/catalog/${task}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
          body: JSON.stringify(payload)
        });

        if (!res.ok || !res.body) {
          outputLog.textContent += `è¯·æ±‚å¤±è´¥: ${res.status}`;
          allButtons.forEach(btn => btn.disabled = false);
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buf = '';

        const appendLine = (line) => { outputLog.textContent += line + '\n'; };

        const handleNote = (dataStr) => {
          const d = parseEventData(dataStr);
          const t = (d && d.text) ? `[${d.phase}] ${d.text}` : String(dataStr || '');
          if (t) appendLine(t);
        };

        const handlePhase = (evName, dataStr) => {
          const d = parseEventData(dataStr);
          const name = (d && d.name) ? d.name : '';
          if (evName === 'phase_start') appendLine(`\n>> å¼€å§‹é˜¶æ®µ: ${name}`);
          if (evName === 'phase_end') appendLine(`<< å®Œæˆé˜¶æ®µ: ${name}\n`);
        };

        const handleArtifact = (dataStr) => {
          const d = parseEventData(dataStr) || {};
          const fn = d.filename || d.id || '';
          const ty = d.type || 'artifact';
          appendLine(`[äº§ç‰©] ${ty}${fn ? ` - ${fn}` : ''}`);
        };

        const handleUpdate = (dataStr) => {
          const d = parseEventData(dataStr) || {};
          appendLine(`   - è¿›åº¦: ${d.progress}`);
        };

        const handleComplete = (dataStr) => {
          const d = parseEventData(dataStr) || {};
          const finalText = d.final_output || '';
          if (d.catalog || d.framework) {
            finalOutput.innerHTML = `<pre>${JSON.stringify(d.catalog || d.framework, null, 2)}</pre>`;
          } else {
            finalOutput.textContent = finalText;
          }
          appendLine('--- æµç¨‹å®Œæˆ ---');
        };

        const handleTokenDelta = (dataStr) => {
          const d = parseEventData(dataStr);
          if (d && d.delta) {
            streamOutput.textContent += d.delta;
          }
        };

        const handleStreamStartEnd = (evName) => {
          if (evName === 'stream_start') streamOutput.textContent += '\n\n===== æ–°çš„æ–‡æœ¬å—å¼€å§‹ =====\n';
        };

        const handleDebugLog = (dataStr) => {
          const data = parseEventData(dataStr) || {};
          const detailedLogContainer = document.getElementById('stream-output');

          let content = `<div class="log-entry">`;
          if (data.title) {
            content += `<h5>${data.title}</h5>`;
          }
          if (data.log_id) {
            content += `<pre id="${data.log_id}"></pre>`;
          }
          content += `</div>`;

          detailedLogContainer.innerHTML += content;
          detailedLogContainer.scrollTop = detailedLogContainer.scrollHeight;
        };

        const handleDebugTokenDelta = (dataStr) => {
          const data = parseEventData(dataStr) || {};
          if (data.log_id && data.delta) {
            const logElement = document.getElementById(data.log_id);
            if (logElement) {
              logElement.textContent += data.delta;
            }
          }
        };

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });
          let idx;
          while ((idx = buf.indexOf('\n\n')) >= 0) {
            const frame = buf.slice(0, idx);
            buf = buf.slice(idx + 2);
            const lines = frame.split('\n');
            let evName = 'message';
            let dataStr = '';
            for (const line of lines) {
              if (line.startsWith('event:')) evName = line.slice(6).trim();
              if (line.startsWith('data:')) dataStr += line.slice(5).trim();
            }

            if (evName === 'phase_start' || evName === 'phase_end') handlePhase(evName, dataStr);
            else if (evName === 'note') handleNote(dataStr);
            else if (evName === 'artifact') handleArtifact(dataStr);
            else if (evName === 'update') handleUpdate(dataStr);
            else if (evName === 'complete') handleComplete(dataStr);
            else if (evName === 'token_delta') handleTokenDelta(dataStr);
            else if (evName === 'stream_start' || evName === 'stream_end') handleStreamStartEnd(evName);
            else if (evName === 'debug_log') handleDebugLog(dataStr);
            else if (evName === 'debug_token_delta') handleDebugTokenDelta(dataStr);
            else if (evName === 'error') appendLine(`[é”™è¯¯] ${dataStr}`);
          }
        }
      } catch (err) {
        outputLog.textContent += `\nå‘ç”Ÿç½‘ç»œé”™è¯¯: ${err}`;
      } finally {
        allButtons.forEach(btn => btn.disabled = false);
      }
    }

    btnFullCatalog.addEventListener('click', () => runStream('generate_full_catalog'));
    btnFramework.addEventListener('click', () => runStream('extract_framework'));
    btnBusiness.addEventListener('click', () => runStream('generate_business_catalog'));
    btnPricing.addEventListener('click', () => runStream('generate_pricing_catalog'));
    btnTechnical.addEventListener('click', () => runStream('generate_technical_catalog'));

  </script>
</body>

</html>